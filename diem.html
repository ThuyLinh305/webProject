<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Điểm - HNMU</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .content {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            margin: 15px;
            border-radius: 4px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .grade-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .grade-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
    </style>
</head>

<body>

    <header class="header">
        <div class="header-left">
            <img src="public/logo.jpg" alt="Logo" class="header-logo">
            <h2>Quản Lý Điểm</h2>
        </div>
        <div class="header-right">
            <a href="#" id="userEmailDisplay">guest@example.com</a>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <ul>
                <li><a href="main_menu.html"><i class="fa-solid fa-house"></i> Trang Chủ</a></li>
                <li><a href="khoa.html"><i class="fa-solid fa-layer-group"></i> Khoa</a></li>
                <li><a href="nganh.html"><i class="fa-solid fa-code-branch"></i> Ngành</a></li>
                <li><a href="chuongTrinhDaoTao.html"><i class="fa-solid fa-graduation-cap"></i> CT Đào Tạo</a></li>
                <li><a href="lop.html"><i class="fa-solid fa-table-cells"></i> Lớp</a></li>
                <li><a href="sinhvien.php"><i class="fa-solid fa-user-graduate"></i> Sinh Viên</a></li>
                <li><a href="giangvien.html"><i class="fa-solid fa-chalkboard-user"></i> Giảng Viên</a></li>
                <li><a href="monhoc.html"><i class="fa-solid fa-book"></i> Môn Học</a></li>
                <li class="active"><a href="diem.html"><i class="fa-solid fa-star"></i> Điểm</a></li>
                <li><a href="diemdanh.html"><i class="fa-solid fa-calendar-check"></i> Điểm Danh</a></li>
            </ul>
        </aside>

        <main class="content">

            <!-- VIEW 1: CLASS LIST -->
            <div id="viewClassList" style="display: block;">
                <h2>Danh sách Bảng điểm Lớp học</h2>

                <div class="toolbar">
                    <div class="search-group">
                        <input type="text" class="input-field" placeholder="Tìm kiếm lớp..." style="margin-bottom: 0;">
                        <button class="btn-search">Tìm kiếm <i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã Lớp</th>
                            <th>Tên Lớp</th>
                            <th>Giảng Viên</th>
                            <th>ĐTB Lớp (GPA)</th>
                            <th>Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody id="classListBody">
                        <!-- JS generated -->
                    </tbody>
                </table>
            </div>

            <!-- VIEW 2: GRADE DETAIL -->
            <div id="viewGradeDetail" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <button class="btn-secondary" onclick="backToClassList()" style="margin-bottom: 10px;">
                            <i class="fa-solid fa-arrow-left"></i> Quay lại
                        </button>
                        <h2 id="detailTitle" style="margin-bottom: 5px;">Bảng điểm lớp ...</h2>
                        <p style="color: #666;">Cách tính: 10% (Lab 1-3) + 30% Kiểm tra + 60% Thi</p>
                    </div>
                </div>

                <div class="attendance-table-container"> <!-- Reusing container style -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2">STT</th>
                                <th rowspan="2">Mã SV</th>
                                <th rowspan="2">Họ Tên</th>
                                <th colspan="3">Điểm Lab (10%)</th>
                                <th rowspan="2">Kiểm tra (30%)</th>
                                <th rowspan="2">Thi (60%)</th>
                                <th rowspan="2">TK (10)</th>
                                <th rowspan="2">Điểm Chữ</th>
                                <th rowspan="2">Trạng Thái</th>
                            </tr>
                            <tr>
                                <th>Lab 1</th>
                                <th>Lab 2</th>
                                <th>Lab 3</th>
                            </tr>
                        </thead>
                        <tbody id="gradeBody">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Mock Data
        const classData = [
            {
                id: "D19CNPM01", name: "CNPM K19 - 01", lecturer: "Nguyễn Văn A",
                students: [
                    { id: "SV001", code: "152019001", name: "Nguyễn Văn A", lab1: 8, lab2: 9, lab3: 9, test: 8, exam: 9 },
                    { id: "SV002", code: "152019002", name: "Trần Thị B", lab1: 7, lab2: 6, lab3: 7, test: 6, exam: 5 },
                    { id: "SV003", code: "152019003", name: "Lê Văn C", lab1: 5, lab2: 4, lab3: 5, test: 4, exam: 3 }, // Fail case
                    { id: "SV004", code: "152019004", name: "Phạm Văn D", lab1: 9, lab2: 9, lab3: 9, test: 9, exam: 9 }
                ]
            },
            {
                id: "D19HTTT01", name: "HTTT K19 - 01", lecturer: "Đỗ Thị E",
                students: [
                    { id: "SV005", code: "152019005", name: "Hoàng Thị F", lab1: 8, lab2: 8, lab3: 8, test: 8, exam: 8 }
                ]
            }
        ];

        // Init
        renderClassList();

        function calculateStudentGrade(s) {
            const labAvg = (s.lab1 + s.lab2 + s.lab3) / 3;
            // Formula: 10% LabAvg + 30% Test + 60% Exam
            const finalScore = (labAvg * 0.1) + (s.test * 0.3) + (s.exam * 0.6);
            return finalScore;
        }

        function calculateClassAvg(students) {
            if (students.length === 0) return 0;
            let sum = 0;
            students.forEach(s => sum += calculateStudentGrade(s));
            return (sum / students.length).toFixed(2);
        }

        function renderClassList() {
            const tbody = document.getElementById('classListBody');
            tbody.innerHTML = '';

            classData.forEach((cls, index) => {
                const avg = calculateClassAvg(cls.students);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${cls.id}</td>
                    <td>${cls.name}</td>
                    <td>${cls.lecturer}</td>
                    <td style="font-weight: bold; color: var(--primary-color);">${avg}</td>
                    <td>
                        <button class="btn-search" onclick="viewClassDetail('${cls.id}')">
                            <i class="fa-solid fa-eye"></i> Xem điểm
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function viewClassDetail(classId) {
            const cls = classData.find(c => c.id === classId);
            if (!cls) return;

            document.getElementById('viewClassList').style.display = 'none';
            document.getElementById('viewGradeDetail').style.display = 'block';
            document.getElementById('detailTitle').textContent = `Bảng điểm lớp ${cls.name}`;

            renderGradeTable(cls);
        }

        function backToClassList() {
            document.getElementById('viewGradeDetail').style.display = 'none';
            document.getElementById('viewClassList').style.display = 'block';
            renderClassList(); // Re-render to update averages if changed (though inputs aren't persistent here without updating model)
        }

        function renderGradeTable(cls) {
            const tbody = document.getElementById('gradeBody');
            tbody.innerHTML = '';

            cls.students.forEach((s, index) => {
                const finalScore = calculateStudentGrade(s).toFixed(2);
                const letter = getLetter(finalScore);
                const passed = finalScore >= 4.0;

                const statusClass = passed ? 'status-ok' : 'status-fail';
                const statusText = passed ? 'Đạt' : 'Trượt';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${s.code}</td>
                    <td style="text-align: left;">${s.name}</td>
                    <td><input type="number" class="grade-input" value="${s.lab1}" min="0" max="10" step="0.1" onchange="updateGrade('${cls.id}', '${s.id}', 'lab1', this.value)"></td>
                    <td><input type="number" class="grade-input" value="${s.lab2}" min="0" max="10" step="0.1" onchange="updateGrade('${cls.id}', '${s.id}', 'lab2', this.value)"></td>
                    <td><input type="number" class="grade-input" value="${s.lab3}" min="0" max="10" step="0.1" onchange="updateGrade('${cls.id}', '${s.id}', 'lab3', this.value)"></td>
                    <td><input type="number" class="grade-input" value="${s.test}" min="0" max="10" step="0.1" onchange="updateGrade('${cls.id}', '${s.id}', 'test', this.value)"></td>
                    <td><input type="number" class="grade-input" value="${s.exam}" min="0" max="10" step="0.1" onchange="updateGrade('${cls.id}', '${s.id}', 'exam', this.value)"></td>
                    
                    <td style="font-weight: bold;">${finalScore}</td>
                    <td style="font-weight: bold;">${letter}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function getLetter(score) {
            if (score < 4.0) return "F";
            if (score < 5.0) return "D"; // 4.0 - 4.9
            if (score < 5.5) return "D+";
            if (score < 6.5) return "C";
            if (score < 7.0) return "C+";
            if (score < 8.0) return "B";
            if (score < 8.5) return "B+";
            return "A";
        }

        function updateGrade(classId, studentId, field, value) {
            const cls = classData.find(c => c.id === classId);
            const student = cls.students.find(s => s.id === studentId);
            if (student) {
                student[field] = parseFloat(value);
                renderGradeTable(cls); // Re-calculate and render row
            }
        }
    </script>
</body>

</html>